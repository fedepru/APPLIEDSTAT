rm(list=ls())
graphics.off()
library(nlmeU) ## --> for the dataset
library(nlme)  ## --> for models implementation
install.packages("nlmeU")
library(nlmeU) ## --> for the dataset
library(corrplot)
library(lattice)
library(plot.matrix)
install.packages("corrplot")
install.packages("plot.matrix")
library(nlmeU) ## --> for the dataset
library(nlme)  ## --> for models implementation
library(corrplot)
library(lattice)
library(plot.matrix)
data(armd) # Age-Related Macular Degeneration: dataset of interest
data(armd0) # Age-Related Macular Degeneration: dataset for visualization
help(armd0)
## Visual-acuity profiles for selected patients --> we visualize some of the trends
armd0.subset <- subset(armd0, as.numeric(subject) %in% seq(1, 240, 5)) # one each 5 patients
xy1 <- xyplot(visual ~ time | treat.f,
groups = subject,
data = armd0.subset,
type = "l", lty = 1)
xy1 <- xyplot(visual ~ time | treat.f,
groups = subject,
data = armd0.subset,
type = "l", lty = 1)
update(xy1, xlab = "Time (in weeks)",
ylab = "Visual acuity",
grid = "h")
## sample means across time and treatment
flst <- list(armd$time.f, armd$treat.f)
tMn <- tapply(armd$visual, flst, FUN = mean)
tMn
## Box-plots for visual acuity by treatment and time
bw1 <- bwplot(visual ~ time.f | treat.f,
data = armd0)
xlims <- c("Base", "4\nwks", "12\nwks", "24\nwks", "52\nwks")
update(bw1, xlim = xlims, pch = "|")
lm6.1 <- lm(visual ~ -1 + visual0 + time.f + treat.f:time.f, data = armd )
## sample means across time and treatment
flst <- list(armd$time.f, armd$treat.f)
tMn <- tapply(armd$visual, flst, FUN = mean)
tMn
## Box-plots for visual acuity by treatment and time
bw1 <- bwplot(visual ~ time.f | treat.f,
data = armd0)
xlims <- c("Base", "4\nwks", "12\nwks", "24\nwks", "52\nwks")
update(bw1, xlim = xlims, pch = "|")
lm6.1 <- lm(visual ~ -1 + visual0 + time.f + treat.f:time.f, data = armd )
summary(lm6.1)
# variance-covariance matrix of Y  --> it is a diagonal matrix with a value of 12.38^2
par(mar = c(4,4,4,4))
plot(diag(x=12.38^2,nrow=12, ncol=12), main='Variance-covariance matrix of Y')
summary(lm6.1)
## residual analysis
plot(lm6.1$residuals) # they seem quite homoscedastic
abline(h=0)
qqnorm(lm6.1$residuals)
qqline(lm6.1$residuals)
shapiro.test(lm6.1$residuals)
## let's color the residuals relative to different patients
colori =rainbow(length(unique(armd$subject)))
num_sub = table(armd$subject)
colori2 = rep(colori, num_sub)
plot(lm6.1$residuals, col=colori2)
abline(h=0)   ## --> not very informative
boxplot(lm6.1$residuals ~ armd$subject, col=colori,
xlab='Subjects', ylab='Residuals', main ='Distribution of residuals across patients')  ## --> informative!
## let's color the residuals relative to different time instants
set.seed(1)
colori =rainbow(4)
colori2 = colori[armd$tp] # associate to each one of the 4 time instants a color
plot(lm6.1$residuals, col=colori2, ylab='residuals')
abline(h=0)
legend(650, -25, legend=c("time 4wks", "time 12wks", "time 24wks", "time 52wks"),
col=colori, lty=1, cex=0.8)
boxplot(lm6.1$residuals ~ armd$time.f, col=colori,
xlab='Time.f', ylab='Residuals')  ## -> the variance of th observations increases in time
## varFunc Class (Chapter 8.2)
?varClasses
# same model of before, using gls()
fm6.1 <- gls(visual ~ -1 + visual0 + time.f + treat.f:time.f, data = armd)
qqnorm(lm6.1$residuals)
qqline(lm6.1$residuals)
qqnorm(lm6.1$residuals)
qqline(lm6.1$residuals)
shapiro.test(lm6.1$residuals)
## let's color the residuals relative to different patients
colori =rainbow(length(unique(armd$subject)))
num_sub = table(armd$subject)
colori2 = rep(colori, num_sub)
plot(lm6.1$residuals, col=colori2)
abline(h=0)   ## --> not very informative
boxplot(lm6.1$residuals ~ armd$subject, col=colori,
xlab='Subjects', ylab='Residuals', main ='Distribution of residuals across patients')  ## --> informative!
## let's color the residuals relative to different time instants
set.seed(1)
colori =rainbow(4)
colori2 = colori[armd$tp] # associate to each one of the 4 time instants a color
plot(lm6.1$residuals, col=colori2, ylab='residuals')
abline(h=0)
legend(650, -25, legend=c("time 4wks", "time 12wks", "time 24wks", "time 52wks"),
col=colori, lty=1, cex=0.8)
boxplot(lm6.1$residuals ~ armd$time.f, col=colori,
xlab='Time.f', ylab='Residuals')  ## -> the variance of th observations increases in time
## varFunc Class (Chapter 8.2)
?varClasses
# same model of before, using gls()
fm6.1 <- gls(visual ~ -1 + visual0 + time.f + treat.f:time.f, data = armd)
fm9.0 <- gls(visual ~ -1 + visual0 + time.f + treat.f:time.f,
weights = varFixed(value = ~time), # Var.function; lambda_i(v_i) (v_i is known and observable)
data = armd)
summary(fm9.0)
anova(fm6.1, fm9.0) # we can compare the models to see which one is better (lower AIC)
# Visualization of variance-covariance matrix of Y (12 observations, 3 patients)
par(mar = c(4,4,4,4))
plot(diag(x=c(  4 * 3.222976^2, # v_i * sigma^2
12 * 3.222976^2,
24 * 3.222976^2,
52 * 3.222976^2), nrow=12, ncol=12),
main='Variance-covariance matrix of Y - VarIdent() - Model 9.0')
# another example
# we suppose that the variance is proportional to 1/visual0
fm9.0b <- gls(visual ~ -1 + visual0 + time.f + treat.f:time.f,
weights = varFixed(value = ~I(1/visual0)), data = armd)
summary(fm9.0b)
anova(fm6.1, fm9.0, fm9.0b)
fm9.1 <- gls(visual ~ -1 + visual0 + time.f + treat.f:time.f,  # the same as before
weights = varIdent(form = ~1|time.f), # Var. function; <delta, stratum>-group
data = armd)
summary(fm9.1)
plot(fm9.1$residuals)
fm9.1$modelStruct$varStruct
intervals(fm9.1, which = "var-cov")  ## 95% CI
# Visualization of Variance-covariance matrix of Y (12 observations, 3 patients)
par(mar = c(4,4,4,4))
plot(diag(x=c(1.000000^2*8.244094^2,  # delta_t^2 * sigma^2
1.397600^2*8.244094^2,
1.664321^2*8.244094^2,
1.880852^2*8.244094^2), nrow=12, ncol=12),
main='Variance-covariance matrix of Y - VarIdent()  - Model 9.1')
anova(fm9.1, fm6.1)  ## fm6.1 C fm9.1
fm9.1 <- gls(visual ~ -1 + visual0 + time.f + treat.f:time.f,  # the same as before
weights = varIdent(form = ~1|time.f), # Var. function; <delta, stratum>-group
data = armd)
summary(fm9.1)
plot(fm9.1$residuals)
fm9.1$modelStruct$varStruct
intervals(fm9.1, which = "var-cov")  ## 95% CI
# Visualization of Variance-covariance matrix of Y (12 observations, 3 patients)
par(mar = c(4,4,4,4))
plot(diag(x=c(1.000000^2*8.244094^2,  # delta_t^2 * sigma^2
1.397600^2*8.244094^2,
1.664321^2*8.244094^2,
1.880852^2*8.244094^2), nrow=12, ncol=12),
main='Variance-covariance matrix of Y - VarIdent()  - Model 9.1')
anova(fm9.1, fm6.1)  ## fm6.1 C fm9.1
fm9.2 <- update(fm9.1, weights = varPower(form = ~time)) # Var. function; <delta>-group
## Notice continuous-time variable "time" rather than to the factor "time.f"
##        if you set time.f, there would be an error
summary(fm9.2)
fm9.2$modelStruct$varStruct
intervals(fm9.2, which = "var-cov")
# Visualization of Variance-covariance matrix of Y (12 observations, 3 patients)
par(mar = c(4,4,4,4))
plot(diag(x=c(4^(2*0.2519332)*5.974906^2,  # TIME_it^{2*delta} * sigma^2
12^(2*0.2519332)*5.974906^2,
24^(2*0.2519332)*5.974906^2,
52^(2*0.2519332)*5.974906^2), nrow=12, ncol=12),
main='Variance-covariance matrix of Y - VarPower() - Model 9.2')
# Test of the variance structure: power of time vs. timepoint-specific variances
anova(fm9.2, fm9.1) # fm9.2 C fm9.1
AIC(fm9.2, fm9.1)  # --> fm9.2 is better in terms of AIC and parsimony!
## Alternatively:
## - with delta = [delta_1, delta_2], strata = treatment group treat.f
fm9.3 <- update(fm9.1,
weights = varPower(form = ~time|treat.f))   # <delta>-group
summary(fm9.3)
anova(fm9.2, fm9.3) # fm9.2 C fm9.3
## raw residuals
plot(fm9.2, resid(., type = "response") ~ fitted(.)) # Raw vs. fitted
plot(fm9.2, resid(., type = "response") ~ time) # Raw vs. time (not shown)
bwplot(resid(fm9.2) ~ time.f, pch = "|", data = armd)
plot(fm9.2, resid(., type = "pearson" ) ~ fitted(.)) # Pearson vs. fitted
plot(fm9.2,resid(., type = "pearson") ~ time)
bwplot( resid(fm9.2, type = "pearson") ~ time.f, # Pearson vs. time.f
pch = "|", data = armd)
## Variogram per time difference (time = 4,12,24,52)
Vg1 <- Variogram(fm9.2, form = ~ time | subject)
Vg1
plot(Vg1, smooth = FALSE, xlab = "Time difference",ylim=c(0,0.7))
fm12.1 <- gls(visual ~ -1 + visual0 + time.f + treat.f:time.f,
weights = varPower(form = ~time),
correlation = corCompSymm(form = ~1|subject),
data = armd)
summary(fm12.1)
intervals(fm12.1, which = "var-cov")
## The marginal variance-covariance structure
## Estimate of R_i (italic)
fm12.1vcov <- getVarCov(fm12.1, individual = "2")  # e.g. i=2
## The marginal variance-covariance structure
## Estimate of R_i (italic)
fm12.1vcov <- getVarCov(fm12.1, individual = "2")  # e.g. i=2
nms <- c("4wks", "12wks", "24wks", "52wks")
dnms <- list(nms, nms)       # Dimnames created
dimnames(fm12.1vcov) <- dnms # Dimnames assigned
print(fm12.1vcov)
## Visualization of R_i (italic)
R_i = fm12.1vcov
R = matrix(0, nrow=28, ncol=28) # example for 7 subjects with all the observations
for(i in 0:6){
R[(i*4+1):(i*4+4),(i*4+1):(i*4+4)] = R_i
}
plot(R)
## The compound-symmetry correlation structure:
## Estimate of C_i
print(cov2cor(fm12.1vcov), corr = TRUE, stdevs = FALSE)  ## Estimate of C_i (correlation matrix)
## Visualization of C_i
C = matrix(0, nrow=28, ncol=28) # example for 7 subjects with all the observations
for(i in 0:6){
C[(i*4+1):(i*4+4),(i*4+1):(i*4+4)] = cov2cor(fm12.1vcov)
}
plot(C)
## Test of independence vs. compound-symmetry correlation structure
anova(fm9.2, fm12.1) # M9.2 C M12.1
fm12.2 <- update(fm9.2,
correlation = corAR1(form = ~tp|subject),
data = armd)
# Notice that (form = ~1 | subject) would lead to a mistake
# as form = ~1|group means "use of the order of the observations in the group as the position index
# and for some subjects, intermittent measurements may be missing
summary(fm12.2)
intervals(fm12.2, which = "var-cov")
## The marginal variance-covariance structure:
## Estimate of R_i (italic)
fm12.2vcov <- getVarCov(fm12.2, individual = "2")  # e.g. i=2
dimnames(fm12.2vcov) <- dnms
fm12.2vcov
## Estimate of C_i (italic)
fm12.2cor <- cov2cor(fm12.2vcov)
print(fm12.2cor, digits = 2,
corr = TRUE, stdevs = FALSE)
# Compound-symmetry vs. autoregressive correlation (nonnested models)
anova(fm12.1, fm12.2)
fm12.3 <- update(fm12.2,
correlation = corSymm(form = ~tp|subject),  ## the variance function is still VarPower()
data = armd)
summary(fm12.3)
intervals(fm12.3, # 95% CIs for rho, delta, sigma
which = "var-cov")
## Estimate of R_i (italic)
fm12.3vcov <- getVarCov(fm12.3, individual = "2")
dimnames(fm12.3vcov) <- dnms
fm12.3vcov   # fm12.3vcov[1,1] = sigma_2 * Lambda[1]^2 = 5.737927^2*(4^0.2712624)^2
## Estimate of C_i
fm12.3cor <- cov2cor(fm12.3vcov)
print(fm12.3cor, corr = TRUE, stdevs = FALSE)
## Autoregressive of order 1 vs. a general correlation structure
anova(fm12.2, fm12.3) # M12.2 C M12.3 --> we prefer M12.3
# (a) Plots (and boxplots) of raw residuals
panel.bwxplot0 <- function(x,y, subscripts, ...){
panel.grid(h = -1)
panel.stripplot(x, y, col = "grey", ...)
panel.bwplot(x, y, pch = "|", ...)
}
bwplot(resid(fm12.3) ~ time.f | treat.f,
panel = panel.bwxplot0,
ylab = "Residuals", data = armd)
plot(fm12.3)
## We therefore decide to visualize the residuals for each time instants
plot(fm12.3,
resid(., type = "p") ~ fitted(.) | time.f)
stdres.plot <-
plot(fm12.3, resid(., type = "p") ~ jitter(time) | treat.f,
id = 0.01, adj = c(-0.3, 0.5 ), grid = FALSE)
plot(update(stdres.plot, # Fig. 12.4
xlim = c(-5,59), ylim = c(-4.9, 4.9), grid = "h"))
##### model fm12.3a #####
# (we add a general intercept; equivalent to 12.3 but refitted with 'ML')
# VISUAL_it = b_0 + b_0t + b_1*VISUAL0_i + b_2*TREAT_i + b_2t*TREAT_i + eps_it
lm1a.form <- formula (visual ~ visual0 + time.f + treat.f + time.f:treat.f)
fm12.3a <- update(fm12.3, lm1a.form,
method = "ML", data = armd)
